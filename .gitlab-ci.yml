# ========================================
# ğŸš€ GitLab CI/CD Pipeline para Joinify
# ========================================
# Proyecto: Joinify - Plataforma de suscripciones compartidas
# TecnologÃ­as: Angular 19 + Node.js + MySQL + Capacitor

image: node:20-alpine

# Definir stages (etapas del pipeline)
stages:
  - install      # Instalar dependencias
  - lint         # AnÃ¡lisis de cÃ³digo
  - test         # Pruebas unitarias
  - build        # ConstrucciÃ³n del proyecto
  - deploy       # Despliegue (opcional)

# ========================================
# ğŸ“¦ CACHE - Optimizar tiempos de ejecuciÃ³n
# ========================================
cache:
  key:
    files:
      - package-lock.json
      - server/package-lock.json
  paths:
    - node_modules/
    - server/node_modules/
    - .npm/

# ========================================
# ğŸ”§ VARIABLES GLOBALES
# ========================================
variables:
  NODE_ENV: "test"
  CHROME_BIN: "/usr/bin/chromium-browser"
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"

# ========================================
# ğŸ“¥ STAGE 1: INSTALACIÃ“N DE DEPENDENCIAS
# ========================================
install:dependencies:
  stage: install
  before_script:
    - echo "ğŸ” Verificando versiones..."
    - node --version
    - npm --version
  script:
    - echo "ğŸ“¦ Instalando dependencias del frontend..."
    - npm ci --cache .npm --prefer-offline
    
    - echo "ğŸ“¦ Instalando dependencias del backend..."
    - cd server
    - npm ci --cache ../.npm --prefer-offline
    - cd ..
    
    - echo "âœ… Dependencias instaladas correctamente"
  artifacts:
    paths:
      - node_modules/
      - server/node_modules/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
        - server/package-lock.json
    paths:
      - node_modules/
      - server/node_modules/
      - .npm/
    policy: pull-push

# ========================================
# ğŸ” STAGE 2: LINTING Y ANÃLISIS DE CÃ“DIGO
# ========================================
lint:frontend:
  stage: lint
  needs:
    - job: install:dependencies
      artifacts: true
  script:
    - echo "ğŸ” Analizando cÃ³digo del frontend..."
    - npx eslint src/**/*.ts --max-warnings 50 || echo "âš ï¸ Advertencias encontradas (no crÃ­ticas)"
    - echo "âœ… AnÃ¡lisis de cÃ³digo completado"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ========================================
# ğŸ§ª STAGE 3: PRUEBAS UNITARIAS
# ========================================

# Pruebas del Frontend (Angular + Karma + Jasmine)
test:frontend:
  stage: test
  needs:
    - job: install:dependencies
      artifacts: true
  before_script:
    # Instalar Chrome/Chromium para las pruebas
    - apk add --no-cache chromium chromium-chromedriver
    - export CHROME_BIN=/usr/bin/chromium-browser
    - export CHROME_PATH=/usr/bin/chromium-browser
  script:
    - echo "ğŸ§ª Ejecutando pruebas del frontend..."
    - npm run test -- --watch=false --browsers=ChromeHeadlessCI --code-coverage
    - echo "âœ… Pruebas del frontend completadas"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# Pruebas del Backend (Node.js + Jest)
test:backend:
  stage: test
  needs:
    - job: install:dependencies
      artifacts: true
  script:
    - echo "ğŸ§ª Ejecutando pruebas del backend..."
    - cd server
    - npm run test:coverage
    - echo "âœ… Pruebas del backend completadas"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: server/coverage/cobertura-coverage.xml
    paths:
      - server/coverage/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# ========================================
# ğŸ—ï¸ STAGE 4: BUILD DEL PROYECTO
# ========================================

# Build del Frontend (Angular)
build:frontend:
  stage: build
  needs:
    - job: install:dependencies
      artifacts: true
    - job: test:frontend
      artifacts: false
  script:
    - echo "ğŸ—ï¸ Construyendo aplicaciÃ³n Angular..."
    - npm run build -- --configuration production
    - echo "âœ… Build completado exitosamente"
    - ls -lah dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

# Build Mobile (Capacitor - Android)
build:mobile:android:
  stage: build
  needs:
    - job: install:dependencies
      artifacts: true
    - job: test:frontend
      artifacts: false
  before_script:
    # Instalar Java (necesario para Capacitor Android)
    - apk add --no-cache openjdk11
    - export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
  script:
    - echo "ğŸ“± Construyendo aplicaciÃ³n mÃ³vil Android..."
    - npm run build:mobile
    - echo "âœ… Build mÃ³vil completado"
  artifacts:
    paths:
      - android/app/build/
    expire_in: 1 week
  only:
    - tags
    - main
  when: manual  # Solo se ejecuta manualmente

# ========================================
# ğŸš€ STAGE 5: DESPLIEGUE (OPCIONAL)
# ========================================

# Deploy a Staging
deploy:staging:
  stage: deploy
  needs:
    - job: build:frontend
      artifacts: true
  script:
    - echo "ğŸš€ Desplegando a entorno de staging..."
    - echo "ğŸ“¦ Archivos a desplegar:"
    - ls -lah dist/
    # AquÃ­ irÃ­an los comandos especÃ­ficos de despliegue
    # Ejemplos:
    # - scp -r dist/* usuario@servidor:/var/www/joinify-staging/
    # - aws s3 sync dist/ s3://joinify-staging/
    # - rsync -avz dist/ usuario@servidor:/var/www/joinify-staging/
    - echo "âœ… Despliegue a staging completado"
  environment:
    name: staging
    url: https://staging.joinify.com
  only:
    - develop
  when: manual

# Deploy a Production
deploy:production:
  stage: deploy
  needs:
    - job: build:frontend
      artifacts: true
  script:
    - echo "ğŸš€ Desplegando a producciÃ³n..."
    - echo "ğŸ“¦ Archivos a desplegar:"
    - ls -lah dist/
    # AquÃ­ irÃ­an los comandos de despliegue a producciÃ³n
    - echo "âœ… Despliegue a producciÃ³n completado"
  environment:
    name: production
    url: https://joinify.com
  only:
    - main
    - tags
  when: manual

# ========================================
# ğŸ“Š REPORTES Y NOTIFICACIONES
# ========================================

# Reporte de cobertura de cÃ³digo
pages:
  stage: deploy
  needs:
    - job: test:frontend
      artifacts: true
    - job: test:backend
      artifacts: true
  script:
    - echo "ğŸ“Š Generando reportes de cobertura..."
    - mkdir -p public/frontend
    - mkdir -p public/backend
    - cp -r coverage/* public/frontend/ || echo "No hay cobertura del frontend"
    - cp -r server/coverage/* public/backend/ || echo "No hay cobertura del backend"
    - echo "âœ… Reportes generados"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main

# ========================================
# ğŸ”§ JOBS AUXILIARES
# ========================================

# ValidaciÃ³n de merge requests
validate:merge-request:
  stage: lint
  needs: []
  script:
    - echo "âœ… Validando merge request..."
    - echo "ğŸ“ Verificando que el tÃ­tulo sea descriptivo..."
    - echo "ğŸ” Verificando que no haya conflictos..."
  only:
    - merge_requests

# Limpieza de cache (manual)
cleanup:cache:
  stage: install
  script:
    - echo "ğŸ§¹ Limpiando cache..."
    - rm -rf node_modules/
    - rm -rf server/node_modules/
    - rm -rf .npm/
    - echo "âœ… Cache limpiado"
  when: manual
  only:
    - main
    - develop
